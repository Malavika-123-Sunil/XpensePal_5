<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>XpensePal - Expense Details</title>
    <link rel="stylesheet" href="style.css">
    <link rel="stylesheet" href="expense.css">
</head>
<body>
    <div class="expense-container">
        <header class="expense-header">
            <div class="header-content">
                <button onclick="goBack()" class="btn-back">
                    <svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round">
                        <path d="M19 12H5M12 19l-7-7 7-7"/>
                    </svg>
                    Back
                </button>
                <h1>Expense Details</h1>
            </div>
        </header>

        <main class="expense-main">
            <div class="expense-form">
                <div class="form-group">
                    <label for="expenseTitle">Expense Title</label>
                    <input type="text" id="expenseTitle" placeholder="e.g., Dinner, Movie Night" required>
                </div>

                <div class="form-group">
                    <label>Participants</label>
                    <div class="participants-container">
                        <div class="participants-list" id="participantsList">
                            <!-- Participants will be added here dynamically -->
                        </div>
                        <button onclick="addParticipant()" class="btn-add-participant">
                            <svg xmlns="http://www.w3.org/2000/svg" width="20" height="20" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round">
                                <path d="M12 5v14M5 12h14"/>
                            </svg>
                            Add Participant
                        </button>
                    </div>
                </div>

                <div class="form-group">
                    <label>Expense Items</label>
                    <div class="expense-items" id="expenseItems">
                        <!-- Expense items will be added here dynamically -->
                    </div>
                    <button onclick="addExpenseItem()" class="btn-add-expense">
                        <svg xmlns="http://www.w3.org/2000/svg" width="20" height="20" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round">
                            <path d="M12 5v14M5 12h14"/>
                        </svg>
                        Add Item
                    </button>
                </div>

                <div class="expense-summary">
                    <h2>Summary</h2>
                    <div class="summary-content" id="expenseSummary">
                        <div class="total-amount">
                            <span>Total Amount:</span>
                            <span class="amount">₹0.00</span>
                        </div>
                        <div class="per-person">
                            <span>Per Person:</span>
                            <span class="amount">₹0.00</span>
                        </div>
                    </div>
                </div>

                <div class="balances-section">
                    <h2>Settlement Details</h2>
                    <div class="balances-list" id="balancesList">
                        <!-- Balances will be shown here -->
                    </div>
                    <div class="settlement-summary" id="settlementSummary">
                        <!-- Settlement instructions will be shown here -->
                    </div>
                </div>

                <div class="payments-section">
                    <h2>Payment Status</h2>
                    <div class="payments-list" id="paymentsList">
                        <!-- Payment status will be shown here -->
                    </div>
                </div>

                <button onclick="saveExpense()" class="btn-save">Save Expense</button>
            </div>
        </main>
    </div>
    <script src="expense.js"></script>
</body>
</html>


.expense-container {
    min-height: 100vh;
    background: var(--color-teal-50);
    display: flex;
    flex-direction: column;
}

.expense-header {
    background: white;
    padding: 1rem 2rem;
    box-shadow: 0 1px 3px rgba(0, 0, 0, 0.1);
}

.header-content {
    max-width: 800px;
    margin: 0 auto;
    display: flex;
    align-items: center;
    gap: 1rem;
}

.btn-back {
    display: flex;
    align-items: center;
    gap: 0.5rem;
    padding: 0.5rem;
    background: transparent;
    border: none;
    color: var(--color-teal-600);
    cursor: pointer;
    transition: all 0.2s ease;
}

.btn-back:hover {
    color: var(--color-teal-700);
}

.expense-header h1 {
    font-size: 1.5rem;
    color: var(--color-gray-900);
    margin: 0;
}

.expense-main {
    flex: 1;
    padding: 2rem;
    max-width: 800px;
    margin: 0 auto;
    width: 100%;
}

.expenses-list {
    margin-bottom: 2rem;
}

.expenses-list h2 {
    font-size: 1.5rem;
    color: var(--color-gray-900);
    margin-bottom: 1rem;
}

.expenses-grid {
    display: grid;
    grid-template-columns: repeat(auto-fill, minmax(250px, 1fr));
    gap: 1rem;
}

.expense-card {
    background: white;
    border-radius: 0.5rem;
    padding: 1rem;
    box-shadow: 0 1px 3px rgba(0, 0, 0, 0.1);
}

.expense-card-header {
    display: flex;
    justify-content: space-between;
    align-items: center;
    margin-bottom: 0.5rem;
}

.expense-card h3 {
    font-size: 1.125rem;
    color: var(--color-gray-900);
    margin: 0;
}

.expense-actions {
    display: flex;
    gap: 0.5rem;
}

.btn-edit,
.btn-delete {
    background: transparent;
    border: none;
    padding: 0.25rem;
    cursor: pointer;
    display: flex;
    align-items: center;
    justify-content: center;
    color: var(--color-gray-600);
    transition: all 0.2s ease;
}

.btn-edit:hover {
    color: var(--color-teal-600);
}

.btn-delete:hover {
    color: #dc2626;
}

.expense-card-content {
    color: var(--color-gray-600);
    font-size: 0.875rem;
}

.expense-form {
    background: white;
    padding: 2rem;
    border-radius: 1rem;
    box-shadow: 0 2px 4px rgba(0, 0, 0, 0.05);
}

.form-group {
    margin-bottom: 1.5rem;
}

.form-group label {
    display: block;
    font-weight: 500;
    color: var(--color-gray-700);
    margin-bottom: 0.5rem;
}

.form-group input[type="text"],
.form-group input[type="number"] {
    width: 100%;
    padding: 0.75rem;
    border: 1px solid var(--color-teal-200);
    border-radius: 0.5rem;
    font-size: 1rem;
    transition: all 0.2s ease;
}

.form-group input:focus {
    outline: none;
    border-color: var(--color-teal-500);
    box-shadow: 0 0 0 3px rgba(13, 148, 136, 0.1);
}

.participants-container {
    margin-top: 0.5rem;
}

.participants-list {
    display: flex;
    flex-wrap: wrap;
    gap: 0.5rem;
    margin-bottom: 1rem;
}

.participant-chip {
    display: flex;
    align-items: center;
    gap: 0.5rem;
    padding: 0.5rem 1rem;
    background: var(--color-teal-50);
    border-radius: 2rem;
    font-size: 0.875rem;
    color: var(--color-teal-700);
}

.btn-remove {
    background: transparent;
    border: none;
    color: var(--color-teal-600);
    cursor: pointer;
    padding: 0.25rem;
    display: flex;
    align-items: center;
    justify-content: center;
    transition: all 0.2s ease;
}

.btn-remove:hover {
    color: var(--color-teal-700);
}

.btn-add-participant,
.btn-add-expense {
    display: flex;
    align-items: center;
    gap: 0.5rem;
    padding: 0.75rem 1rem;
    background: var(--color-teal-50);
    border: 1px dashed var(--color-teal-300);
    color: var(--color-teal-600);
    border-radius: 0.5rem;
    cursor: pointer;
    font-weight: 500;
    width: 100%;
    justify-content: center;
    transition: all 0.2s ease;
}

.btn-add-participant:hover,
.btn-add-expense:hover {
    background: var(--color-teal-100);
    border-color: var(--color-teal-400);
}

.expense-items {
    margin-bottom: 1rem;
}

.expense-item {
    background: var(--color-teal-50);
    border-radius: 0.5rem;
    padding: 1rem;
    margin-bottom: 0.5rem;
}

.expense-item-header {
    display: grid;
    grid-template-columns: 1fr auto auto;
    gap: 1rem;
    align-items: center;
    margin-bottom: 0.5rem;
}

.expense-item-details {
    margin-top: 0.5rem;
    padding-top: 0.5rem;
    border-top: 1px solid var(--color-teal-100);
}

.payer-select {
    padding: 0.5rem;
    border: 1px solid var(--color-teal-200);
    border-radius: 0.375rem;
    background: white;
    color: var(--color-gray-700);
    width: 100%;
    margin-top: 0.5rem;
}

.expense-summary {
    margin-top: 2rem;
    padding-top: 1.5rem;
    border-top: 1px solid var(--color-teal-100);
}

.expense-summary h2,
.balances-section h2,
.payments-section h2 {
    font-size: 1.25rem;
    color: var(--color-gray-900);
    margin-bottom: 1rem;
}

.summary-content {
    background: var(--color-teal-50);
    padding: 1.5rem;
    border-radius: 0.5rem;
}

.total-amount,
.per-person {
    display: flex;
    justify-content: space-between;
    align-items: center;
    color: var(--color-gray-700);
    font-size: 1rem;
}

.total-amount {
    padding-bottom: 0.75rem;
    margin-bottom: 0.75rem;
    border-bottom: 1px solid var(--color-teal-100);
}

.amount {
    font-weight: 600;
    color: var(--color-gray-900);
}

.balances-section,
.payments-section {
    margin-top: 2rem;
    padding-top: 1.5rem;
    border-top: 1px solid var(--color-teal-100);
}

.balance-item {
    display: flex;
    justify-content: space-between;
    align-items: center;
    padding: 1rem;
    background: var(--color-teal-50);
    border-radius: 0.5rem;
    margin-bottom: 0.5rem;
}

.balance-info {
    flex: 1;
}

.btn-add-payment {
    padding: 0.5rem 1rem;
    background: var(--color-teal-600);
    color: white;
    border: none;
    border-radius: 0.375rem;
    cursor: pointer;
    font-size: 0.875rem;
    transition: all 0.2s ease;
    margin-left: 1rem;
}

.btn-add-payment:hover {
    background: var(--color-teal-700);
}

.balance-positive {
    color: #059669;
}

.balance-negative {
    color: #dc2626;
}

.settlement-summary {
    margin-top: 1rem;
    padding: 1rem;
    background: white;
    border: 1px solid var(--color-teal-100);
    border-radius: 0.5rem;
}

.settlement-item {
    padding: 0.5rem 0;
    border-bottom: 1px solid var(--color-teal-50);
}

.settlement-item:last-child {
    border-bottom: none;
}

.payment-item {
    display: flex;
    justify-content: space-between;
    align-items: center;
    padding: 1rem;
    background: var(--color-teal-50);
    border-radius: 0.5rem;
    margin-bottom: 0.5rem;
}

.payment-status {
    display: flex;
    align-items: center;
    gap: 0.5rem;
}

.status-pending {
    color: #d97706;
}

.status-completed {
    color: #059669;
}

.btn-mark-paid {
    padding: 0.5rem 1rem;
    background: var(--color-teal-600);
    color: white;
    border: none;
    border-radius: 0.375rem;
    cursor: pointer;
    font-size: 0.875rem;
    transition: all 0.2s ease;
}

.btn-mark-paid:hover {
    background: var(--color-teal-700);
}

.btn-save {
    margin-top: 2rem;
    width: 100%;
    padding: 1rem;
    background: var(--color-teal-600);
    color: white;
    border: none;
    border-radius: 0.5rem;
    font-weight: 500;
    cursor: pointer;
    transition: all 0.2s ease;
}

.btn-save:hover {
    background: var(--color-teal-700);
}

@media (max-width: 640px) {
    .expense-header {
        padding: 1rem;
    }

    .expense-main {
        padding: 1rem;
    }

    .expense-form {
        padding: 1.5rem;
    }

    .expense-item-header {
        grid-template-columns: 1fr auto;
        gap: 0.5rem;
    }

    .expenses-grid {
        grid-template-columns: 1fr;
    }
}

/* Add these styles for payment tracking */
.payment-section {
    background-color: white;
    border-radius: 8px;
    padding: 20px;
    margin-top: 20px;
    box-shadow: 0 2px 4px rgba(0,0,0,0.1);
}

.payment-status {
    padding: 4px 8px;
    border-radius: 12px;
    font-size: 0.9em;
    margin-left: 10px;
}

.payment-status.completed {
    background-color: #d4edda;
    color: #155724;
}

.payment-status.pending {
    background-color: #fff3cd;
    color: #856404;
}

.balance-info {
    display: flex;
    align-items: center;
    justify-content: space-between;
    width: 100%;
}

.balance-amount {
    font-weight: bold;
}

/* Add styles for payment suggestions */
.payment-suggestions {
    margin-top: 20px;
    padding-top: 15px;
    border-top: 1px solid #dee2e6;
}

.suggestion-item {
    padding: 10px;
    margin: 5px 0;
    background-color: #f8f9fa;
    border-radius: 4px;
    display: flex;
    justify-content: space-between;
    align-items: center;
}

.member-payment-status {
    background-color: white;
    border-radius: 8px;
    padding: 15px;
    margin-bottom: 15px;
    box-shadow: 0 2px 4px rgba(0,0,0,0.1);
}

.member-header {
    display: flex;
    justify-content: space-between;
    align-items: center;
    margin-bottom: 10px;
}

.member-name {
    font-size: 1.1em;
    font-weight: bold;
    color: #2c3e50;
}

.payment-status {
    padding: 8px 12px;
    border-radius: 4px;
    font-size: 0.9em;
    margin-top: 5px;
}

.payment-status.completed {
    background-color: #d4edda;
    color: #155724;
}

.payment-status.pending {
    background-color: #fff3cd;
    color: #856404;
}

.payment-input-group {
    display: flex;
    gap: 8px;
    align-items: center;
}

.payment-amount {
    width: 120px;
    padding: 6px 10px;
    border: 1px solid #ddd;
    border-radius: 4px;
    font-size: 0.9em;
}

.btn-record-payment {
    background-color: #28a745;
    color: white;
    border: none;
    padding: 6px 12px;
    border-radius: 4px;
    cursor: pointer;
    font-size: 0.9em;
}

.btn-record-payment:hover {
    background-color: #218838;
}

.payment-status-item {
    background-color: white;
    border-radius: 8px;
    padding: 15px;
    margin-bottom: 15px;
    box-shadow: 0 2px 4px rgba(0,0,0,0.1);
}

.member-payment-info {
    display: flex;
    justify-content: space-between;
    align-items: center;
    gap: 20px;
}

.member-details {
    flex: 1;
}

.member-name {
    font-size: 1.1em;
    font-weight: bold;
    color: #2c3e50;
    margin-bottom: 8px;
}

.payment-amounts {
    display: flex;
    flex-direction: column;
    gap: 6px;
}

.total-share, .amount-paid {
    color: #666;
    font-size: 0.9em;
}

.amount-remaining {
    font-weight: 500;
    padding: 4px 8px;
    border-radius: 4px;
    display: inline-block;
    font-size: 0.9em;
}

.amount-remaining.pending {
    background-color: #fff3cd;
    color: #856404;
}

.amount-remaining.completed {
    background-color: #d4edda;
    color: #155724;
}

.btn-record {
    background-color: #28a745;
    color: white;
    border: none;
    padding: 8px 16px;
    border-radius: 4px;
    cursor: pointer;
    font-size: 0.9em;
    display: flex;
    align-items: center;
    gap: 6px;
}

.btn-record:hover {
    background-color: #218838;
}

.btn-record i {
    font-size: 0.9em;
}

.payment-history {
    margin-top: 15px;
    padding-top: 10px;
    border-top: 1px solid #eee;
}

.history-header {
    font-size: 0.9em;
    color: #666;
    margin-bottom: 8px;
}

.payment-record {
    display: flex;
    justify-content: space-between;
    padding: 4px 0;
    font-size: 0.9em;
}

.payment-date {
    color: #666;
}

.no-payments {
    color: #666;
    font-style: italic;
    font-size: 0.9em;
}


let participants = [];
let expenseItems = [];
let payments = [];
let currentRoomCode = '';
let currentExpenseId = null;

// Initialize the page with room code and load existing expenses
function initializePage() {
    currentRoomCode = localStorage.getItem('currentRoom');
    if (!currentRoomCode) {
        alert('No room code found. Redirecting to dashboard...');
        window.location.href = 'dashboard.html';
        return;
    }

    loadRoomExpenses();
    renderParticipants();
    renderExpenseItems();
    updateSummary();
}

function loadRoomExpenses() {
    const roomData = JSON.parse(localStorage.getItem(`room_${currentRoomCode}`) || '{"expenses": []}');
    renderExpensesList(roomData.expenses);
}

function renderExpensesList(expenses) {
    const container = document.createElement('div');
    container.className = 'expenses-list';
    container.innerHTML = `
        <h2>Expenses in this Room</h2>
        <div class="expenses-grid">
            ${expenses.map(expense => `
                <div class="expense-card" data-id="${expense.id}">
                    <div class="expense-card-header">
                        <h3>${expense.title}</h3>
                        <div class="expense-actions">
                            <button onclick="editExpense('${expense.id}')" class="btn-edit">
                                <svg xmlns="http://www.w3.org/2000/svg" width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round">
                                    <path d="M17 3a2.85 2.83 0 1 1 4 4L7.5 20.5 2 22l1.5-5.5L17 3z"/>
                                </svg>
                            </button>
                            <button onclick="deleteExpense('${expense.id}')" class="btn-delete">
                                <svg xmlns="http://www.w3.org/2000/svg" width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round">
                                    <path d="M3 6h18M19 6v14c0 1-1 2-2 2H7c-1 0-2-1-2-2V6M8 6V4c0-1 1-2 2-2h4c1 0 2 1 2 2v2"/>
                                </svg>
                            </button>
                        </div>
                    </div>
                    <div class="expense-card-content">
                        <p>Total: ₹${expense.totalAmount.toFixed(2)}</p>
                        <p>Date: ${new Date(expense.timestamp).toLocaleDateString()}</p>
                    </div>
                </div>
            `).join('')}
        </div>
    `;

    // Insert the expenses list before the expense form
    const expenseForm = document.querySelector('.expense-form');
    expenseForm.parentNode.insertBefore(container, expenseForm);
}

function editExpense(expenseId) {
    const roomData = JSON.parse(localStorage.getItem(`room_${currentRoomCode}`) || '{"expenses": []}');
    const expense = roomData.expenses.find(e => e.id === expenseId);
    
    if (expense) {
        currentExpenseId = expenseId;
        document.getElementById('expenseTitle').value = expense.title;
        participants = [...expense.participants];
        expenseItems = [...expense.items];
        payments = expense.payments || [];
        
        renderParticipants();
        renderExpenseItems();
        updateSummary();
        
        // Scroll to the form
        document.querySelector('.expense-form').scrollIntoView({ behavior: 'smooth' });
    }
}

function deleteExpense(expenseId) {
    if (confirm('Are you sure you want to delete this expense?')) {
        const roomData = JSON.parse(localStorage.getItem(`room_${currentRoomCode}`) || '{"expenses": []}');
        roomData.expenses = roomData.expenses.filter(e => e.id !== expenseId);
        localStorage.setItem(`room_${currentRoomCode}`, JSON.stringify(roomData));
        loadRoomExpenses();
    }
}

function goBack() {
    window.location.href = 'dashboard.html';
}

function addParticipant() {
    const name = prompt('Enter participant name:');
    if (name && name.trim()) {
        participants.push({
            name: name.trim(),
            totalPaid: 0,
            balance: 0,
            payments: []
        });
        renderParticipants();
        updatePayerSelections();
        updateSummary();
    }
}

function removeParticipant(index) {
    if (confirm('Remove this participant? Their payment history will be lost.')) {
    participants.splice(index, 1);
    renderParticipants();
        updatePayerSelections();
    updateSummary();
    }
}

function renderParticipants() {
    const list = document.getElementById('participantsList');
    list.innerHTML = participants.map((participant, index) => `
        <div class="participant-chip">
            <span>${participant.name}</span>
            <button onclick="removeParticipant(${index})" class="btn-remove">
                <svg xmlns="http://www.w3.org/2000/svg" width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round">
                    <path d="M18 6L6 18M6 6l12 12"/>
                </svg>
            </button>
        </div>
    `).join('');
}

function updatePayerSelections() {
    document.querySelectorAll('.payer-select').forEach(select => {
        const currentValue = select.value;
        select.innerHTML = `
            <option value="">Select payer</option>
            ${participants.map(p => `
                <option value="${p.name}" ${currentValue === p.name ? 'selected' : ''}>
                    ${p.name}
                </option>
            `).join('')}
        `;
    });
}

function addExpenseItem() {
    const item = {
        id: Date.now(),
        description: '',
        amount: 0,
        payer: '',
        splitAmount: 0
    };
    expenseItems.push(item);
    renderExpenseItems();
}

function removeExpenseItem(id) {
    expenseItems = expenseItems.filter(item => item.id !== id);
    renderExpenseItems();
    updateSummary();
}

function updateExpenseItem(id, field, value) {
    const item = expenseItems.find(item => item.id === id);
    if (item) {
        item[field] = value;
        if (field === 'amount' || field === 'payer') {
            item.splitAmount = Number(item.amount) / participants.length;
        }
        updateSummary();
    }
}

function renderExpenseItems() {
    const container = document.getElementById('expenseItems');
    container.innerHTML = expenseItems.map(item => `
        <div class="expense-item">
            <div class="expense-item-header">
            <input
                type="text"
                placeholder="Description"
                value="${item.description}"
                onchange="updateExpenseItem(${item.id}, 'description', this.value)"
            >
            <input
                type="number"
                placeholder="Amount"
                value="${item.amount}"
                onchange="updateExpenseItem(${item.id}, 'amount', Number(this.value))"
                min="0"
                step="0.01"
            >
            <button onclick="removeExpenseItem(${item.id})" class="btn-remove">
                <svg xmlns="http://www.w3.org/2000/svg" width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round">
                    <path d="M18 6L6 18M6 6l12 12"/>
                </svg>
            </button>
            </div>
            <div class="expense-item-details">
                <select 
                    class="payer-select"
                    onchange="updateExpenseItem(${item.id}, 'payer', this.value)"
                >
                    <option value="">Select payer</option>
                    ${participants.map(p => `
                        <option value="${p.name}" ${item.payer === p.name ? 'selected' : ''}>
                            ${p.name}
                        </option>
                    `).join('')}
                </select>
            </div>
        </div>
    `).join('');
}

function updateSummary() {
    const totalAmount = expenseItems.reduce((sum, item) => sum + (Number(item.amount) || 0), 0);
    const perPerson = participants.length ? totalAmount / participants.length : 0;

    // Calculate individual balances
    participants.forEach(participant => {
        const paid = expenseItems
            .filter(item => item.payer === participant.name)
            .reduce((sum, item) => sum + (Number(item.amount) || 0), 0);
        
        // Add manual payments
        const manualPayments = participant.payments ? 
            participant.payments.reduce((sum, payment) => sum + payment.amount, 0) : 0;
        
        participant.totalPaid = paid + manualPayments;
        participant.balance = participant.totalPaid - perPerson;
    });

    // Update summary section
    const summary = document.getElementById('expenseSummary');
    summary.innerHTML = `
        <div class="total-amount">
            <span>Total Amount:</span>
            <span class="amount">₹${totalAmount.toFixed(2)}</span>
        </div>
        <div class="per-person">
            <span>Per Person:</span>
            <span class="amount">₹${perPerson.toFixed(2)}</span>
        </div>
    `;

    // Update balances section
    const balancesList = document.getElementById('balancesList');
    balancesList.innerHTML = participants.map(participant => `
        <div class="balance-item">
            <div class="balance-info">
                <span>${participant.name}</span>
                <span class="amount ${participant.balance >= 0 ? 'balance-positive' : 'balance-negative'}">
                    ${participant.balance >= 0 ? '₹' + participant.balance.toFixed(2) + ' (to receive)' : 
                    '₹' + Math.abs(participant.balance).toFixed(2) + ' (to pay)'}
                </span>
            </div>
            <button onclick="addManualPayment('${participant.name}')" class="btn-add-payment">
                Add Payment
            </button>
        </div>
    `).join('');

    // Calculate and display settlement
    const settlementSummary = document.getElementById('settlementSummary');
    const settlements = calculateSettlements();
    settlementSummary.innerHTML = `
        <h3>Settlement Plan</h3>
        ${settlements.map(settlement => `
            <div class="settlement-item">
                ${settlement.from} pays ₹${settlement.amount.toFixed(2)} to ${settlement.to}
            </div>
        `).join('')}
    `;

    // Update payments section
    renderPayments(settlements);
}

function addManualPayment(participantName) {
    const amount = prompt(`Enter payment amount for ${participantName}:`);
    if (amount && !isNaN(amount) && Number(amount) > 0) {
        const participant = participants.find(p => p.name === participantName);
        if (participant) {
            if (!participant.payments) {
                participant.payments = [];
            }
            participant.payments.push({
                amount: Number(amount),
                timestamp: new Date().toISOString()
            });
            updateSummary();
        }
    }
}

function calculateSettlements() {
    const settlements = [];
    const debtors = participants.filter(p => p.balance < 0)
        .sort((a, b) => a.balance - b.balance);
    const creditors = participants.filter(p => p.balance > 0)
        .sort((a, b) => b.balance - a.balance);

    debtors.forEach(debtor => {
        let remainingDebt = Math.abs(debtor.balance);
        creditors.forEach(creditor => {
            if (remainingDebt > 0 && creditor.balance > 0) {
                const amount = Math.min(remainingDebt, creditor.balance);
                if (amount > 0) {
                    settlements.push({
                        from: debtor.name,
                        to: creditor.name,
                        amount: amount,
                        status: 'pending'
                    });
                    remainingDebt -= amount;
                    creditor.balance -= amount;
                }
            }
        });
    });

    return settlements;
}

function renderPayments(settlements) {
    const paymentsList = document.getElementById('paymentsList');
    paymentsList.innerHTML = settlements.map((settlement, index) => `
        <div class="payment-item">
            <div>
                ${settlement.from} → ${settlement.to}: ₹${settlement.amount.toFixed(2)}
            </div>
            <div class="payment-status">
                ${settlement.status === 'pending' ? `
                    <span class="status-pending">Pending</span>
                    <button onclick="markPaymentComplete(${index})" class="btn-mark-paid">
                        Mark as Paid
                    </button>
                ` : `
                    <span class="status-completed">Completed</span>
                `}
            </div>
        </div>
    `).join('');
}

function markPaymentComplete(index) {
    const settlements = calculateSettlements();
    settlements[index].status = 'completed';
    
    // Add the payment to the participant's payment history
    const settlement = settlements[index];
    const payer = participants.find(p => p.name === settlement.from);
    if (payer) {
        if (!payer.payments) payer.payments = [];
        payer.payments.push({
            amount: settlement.amount,
            timestamp: new Date().toISOString(),
            to: settlement.to
        });
    }
    
    renderPayments(settlements);
    updateSummary();
}

function saveExpense() {
    const title = document.getElementById('expenseTitle').value;
    
    if (!title) {
        alert('Please enter an expense title');
        return;
    }
    
    if (participants.length === 0) {
        alert('Please add at least one participant');
        return;
    }
    
    if (expenseItems.length === 0) {
        alert('Please add at least one expense item');
        return;
    }

    if (expenseItems.some(item => !item.payer)) {
        alert('Please select a payer for all expense items');
        return;
    }

    const expense = {
        id: currentExpenseId || Date.now().toString(),
        title,
        participants,
        items: expenseItems,
        totalAmount: expenseItems.reduce((sum, item) => sum + (Number(item.amount) || 0), 0),
        settlements: calculateSettlements(),
        payments,
        timestamp: new Date().toISOString()
    };

    // Save to room storage
    const roomData = JSON.parse(localStorage.getItem(`room_${currentRoomCode}`) || '{"expenses": []}');
    
    if (currentExpenseId) {
        // Update existing expense
        const index = roomData.expenses.findIndex(e => e.id === currentExpenseId);
        if (index !== -1) {
            roomData.expenses[index] = expense;
        }
    } else {
        // Add new expense
        roomData.expenses.push(expense);
    }
    
    localStorage.setItem(`room_${currentRoomCode}`, JSON.stringify(roomData));

    alert('Expense saved successfully!');
    
    // Reset form for new expense
    currentExpenseId = null;
    document.getElementById('expenseTitle').value = '';
    participants = [];
    expenseItems = [];
    payments = [];
    
    // Reload expenses list
    loadRoomExpenses();
    renderParticipants();
    renderExpenseItems();
    updateSummary();
}

// Initialize the page
initializePage();

// Structure for tracking payments between participants
class PaymentTracker {
    constructor(roomId) {
        this.roomId = roomId;
        this.payments = new Map();
    }

    // Record a payment between participants
    async recordPayment(fromUserId, toUserId, amount) {
        try {
            const roomRef = doc(db, 'rooms', this.roomId);
            const roomSnap = await getDoc(roomRef);
            const roomData = roomSnap.data();

            const payment = {
                fromUserId,
                toUserId,
                amount,
                timestamp: new Date().toISOString(),
                status: 'completed'
            };

            // Add payment to payments collection
            await addDoc(collection(db, 'rooms', this.roomId, 'payments'), payment);

            // Update user balances
            await this.updateBalances(roomData, payment);
            
            // Check and update payment completion status
            await this.checkPaymentCompletion(roomData);

        } catch (error) {
            console.error('Error recording payment:', error);
            throw error;
        }
    }

    // Update balances after a payment
    async updateBalances(roomData, payment) {
        const updatedMembers = roomData.members.map(member => {
            if (member.userId === payment.fromUserId) {
                return {
                    ...member,
                    totalPaid: (member.totalPaid || 0) + payment.amount
                };
            }
            if (member.userId === payment.toUserId) {
                return {
                    ...member,
                    totalReceived: (member.totalReceived || 0) + payment.amount
                };
            }
            return member;
        });

        await updateDoc(doc(db, 'rooms', this.roomId), {
            members: updatedMembers,
            lastUpdated: new Date().toISOString()
        });
    }

    // Check if all payments are completed
    async checkPaymentCompletion(roomData) {
        const members = roomData.members;
        const expenses = roomData.expenses || [];
        
        // Calculate total owed per person
        const totalOwed = {};
        members.forEach(member => {
            totalOwed[member.userId] = 0;
        });

        expenses.forEach(expense => {
            const perPersonShare = expense.amount / members.length;
            members.forEach(member => {
                if (member.userId === expense.paidBy) {
                    totalOwed[member.userId] -= (expense.amount - perPersonShare);
                } else {
                    totalOwed[member.userId] += perPersonShare;
                }
            });
        });

        // Update payment status for each member
        const updatedMembers = members.map(member => ({
            ...member,
            paymentStatus: Math.abs(totalOwed[member.userId]) < 0.01 ? 'completed' : 'pending'
        }));

        await updateDoc(doc(db, 'rooms', this.roomId), {
            members: updatedMembers
        });
    }
}

// Function to update balance and payment display
async function updateBalanceAndPayments() {
    try {
        const currentRoomId = localStorage.getItem('currentRoomId');
        if (!currentRoomId) return;

        const roomRef = doc(db, 'rooms', currentRoomId);
        const roomSnap = await getDoc(roomRef);
        const roomData = roomSnap.data();

        // Get all payments for this room
        const paymentsSnapshot = await getDocs(collection(db, 'rooms', currentRoomId, 'payments'));
        const payments = paymentsSnapshot.docs.map(doc => doc.data());

        const balancesList = document.getElementById('balancesList');
        if (!balancesList) return;

        balancesList.innerHTML = '<h3>Payment Status</h3>';

        // Calculate initial balances from expenses
        const balances = calculateBalances(roomData.expenses, roomData.members);
        
        // Create payment tracking object
        const paymentTracking = {};
        roomData.members.forEach(member => {
            paymentTracking[member.userId] = {
                owes: {},
                paid: {},
                totalOwed: 0,
                totalPaid: 0
            };
        });

        // Calculate who owes whom
        roomData.expenses.forEach(expense => {
            const perPersonShare = expense.amount / roomData.members.length;
            roomData.members.forEach(member => {
                if (member.userId !== expense.paidBy) {
                    paymentTracking[member.userId].owes[expense.paidBy] = 
                        (paymentTracking[member.userId].owes[expense.paidBy] || 0) + perPersonShare;
                    paymentTracking[member.userId].totalOwed += perPersonShare;
                }
            });
        });

        // Record all payments made
        payments.forEach(payment => {
            paymentTracking[payment.fromUserId].paid[payment.toUserId] = 
                (paymentTracking[payment.fromUserId].paid[payment.toUserId] || 0) + payment.amount;
            paymentTracking[payment.fromUserId].totalPaid += payment.amount;
        });

        // Display balances and payments for each member
        roomData.members.forEach(member => {
            const memberDiv = document.createElement('div');
            memberDiv.className = 'member-payment-status';

            const tracking = paymentTracking[member.userId];
            const remainingTotal = tracking.totalOwed - tracking.totalPaid;

            // Create payment details for each person they owe
            const paymentDetails = Object.entries(tracking.owes).map(([owedToId, amount]) => {
                const paidAmount = tracking.paid[owedToId] || 0;
                const remaining = amount - paidAmount;
                const owedToMember = roomData.members.find(m => m.userId === owedToId);
                
                if (remaining <= 0) {
                    return `<div class="payment-detail completed">
                        <span>✓ Paid ${formatAmount(amount)} to ${owedToMember.name}</span>
                    </div>`;
                } else {
                    return `<div class="payment-detail pending">
                        <span>Owes ${formatAmount(remaining)} to ${owedToMember.name}</span>
                        <span class="paid-amount">Paid: ${formatAmount(paidAmount)}</span>
                    </div>`;
                }
            }).join('');

            memberDiv.innerHTML = `
                <div class="member-header">
                    <span class="member-name">${member.name}</span>
                    <span class="payment-status ${remainingTotal <= 0 ? 'completed' : 'pending'}">
                        ${remainingTotal <= 0 ? 
                            '✓ All Payments Completed' : 
                            `Remaining: ${formatAmount(remainingTotal)}`}
                    </span>
                </div>
                <div class="payment-details">
                    ${paymentDetails}
                </div>
            `;

            balancesList.appendChild(memberDiv);
        });

    } catch (error) {
        console.error('Error updating balance and payments:', error);
    }
}

// Function to record a payment
async function addManualPayment(event) {
    event.preventDefault();
    try {
        const amount = parseFloat(document.getElementById('paymentAmount').value);
        const toUserId = document.getElementById('paymentTo').value;
        const currentUser = auth.currentUser;
        const currentRoomId = localStorage.getItem('currentRoomId');

        if (!amount || !toUserId || !currentUser || !currentRoomId) {
            alert('Please fill all payment details');
            return;
        }

        const payment = {
            fromUserId: currentUser.uid,
            toUserId,
            amount,
            timestamp: new Date().toISOString(),
            status: 'completed'
        };

        // Add payment to payments collection
        await addDoc(collection(db, 'rooms', currentRoomId, 'payments'), payment);

        // Reset form and update UI
        document.getElementById('paymentForm').reset();
        await updateBalanceAndPayments();
        
        alert('Payment recorded successfully');

    } catch (error) {
        console.error('Error adding payment:', error);
        alert('Error recording payment');
    }
}

// Function to update payment recipient select
function updatePaymentRecipientSelect() {
    const currentRoomId = localStorage.getItem('currentRoomId');
    if (!currentRoomId) return;

    const currentUser = auth.currentUser;
    if (!currentUser) return;

    getDoc(doc(db, 'rooms', currentRoomId)).then(roomSnap => {
        if (!roomSnap.exists()) return;

        const roomData = roomSnap.data();
        const paymentToSelect = document.getElementById('paymentTo');
        
        if (!paymentToSelect) return;

        paymentToSelect.innerHTML = '<option value="">Select recipient</option>' +
            roomData.members
                .filter(member => member.userId !== currentUser.uid) // Exclude current user
                .map(member => `
                    <option value="${member.userId}">${member.name}</option>
                `).join('');
    });
}

// Add to your document ready code
document.addEventListener('DOMContentLoaded', () => {
    // ... existing initialization code ...

    // Set up real-time updates for expenses and payments
    const currentRoomId = localStorage.getItem('currentRoomId');
    if (currentRoomId) {
        const roomRef = doc(db, 'rooms', currentRoomId);
        
        // Listen for room changes
        onSnapshot(roomRef, (doc) => {
            if (doc.exists()) {
                updateBalanceAndPayments();
                updatePaymentRecipientSelect();
            }
        });

        // Listen for payment changes
        onSnapshot(collection(db, 'rooms', currentRoomId, 'payments'), () => {
            updateBalanceAndPayments();
        });
    }

    // Initialize payment form
    updatePaymentRecipientSelect();
});

// Add this HTML for the payment form

// Function to update payment status display
async function updatePaymentStatus() {
    try {
        const currentRoomId = localStorage.getItem('currentRoomId');
        if (!currentRoomId) return;

        const roomRef = doc(db, 'rooms', currentRoomId);
        const roomSnap = await getDoc(roomRef);
        const roomData = roomSnap.data();

        const paymentsList = document.getElementById('paymentsList');
        if (!paymentsList) return;

        paymentsList.innerHTML = ''; // Clear existing content

        roomData.members.forEach(member => {
            const totalShare = calculateMemberShare(roomData.expenses, member.userId);
            const totalPaid = calculateTotalPaid(roomData.payments || [], member.userId);
            const remaining = totalShare - totalPaid;

            const memberPaymentDiv = document.createElement('div');
            memberPaymentDiv.className = 'payment-status-item';
            memberPaymentDiv.innerHTML = `
                <div class="member-payment-info">
                    <div class="member-details">
                        <span class="member-name">${member.name}</span>
                        <div class="payment-amounts">
                            <span class="total-share">Share Amount: ₹${totalShare.toFixed(2)}</span>
                            <span class="amount-paid">Paid: ₹${totalPaid.toFixed(2)}</span>
                            <span class="amount-remaining ${remaining <= 0 ? 'completed' : 'pending'}">
                                ${remaining <= 0 ? 
                                    '✓ Fully Paid' : 
                                    `Remaining: ₹${remaining.toFixed(2)}`}
                            </span>
                        </div>
                    </div>
                    ${remaining > 0 ? `
                        <button onclick="recordPayment('${member.userId}', ${remaining})" 
                                class="btn-record">
                            <i class="fas fa-check"></i> Record Payment
                        </button>
                    ` : ''}
                </div>
            `;
            paymentsList.appendChild(memberPaymentDiv);
        });

    } catch (error) {
        console.error('Error updating payment status:', error);
    }
}

// Function to record a payment
async function recordPayment(userId, remainingAmount) {
    try {
        const amount = parseFloat(prompt(`Enter payment amount (Maximum: ₹${remainingAmount.toFixed(2)})`));

        if (!amount || isNaN(amount)) {
            alert('Please enter a valid amount');
            return;
        }

        if (amount <= 0) {
            alert('Amount must be greater than 0');
            return;
        }

        if (amount > remainingAmount) {
            alert('Amount cannot exceed remaining balance');
            return;
        }

        const currentRoomId = localStorage.getItem('currentRoomId');
        if (!currentRoomId) {
            alert('Room not found');
            return;
        }

        // Record the payment
        const payment = {
            userId: userId,
            amount: amount,
            timestamp: new Date().toISOString()
        };

        const roomRef = doc(db, 'rooms', currentRoomId);
        await updateDoc(roomRef, {
            payments: arrayUnion(payment),
            lastUpdated: new Date().toISOString()
        });

        await updatePaymentStatus();
        alert('Payment recorded successfully');

    } catch (error) {
        console.error('Error recording payment:', error);
        alert('Error recording payment');
    }
}

// Helper function to calculate member's share
function calculateMemberShare(expenses, userId) {
    return expenses.reduce((total, expense) => {
        const perPersonShare = expense.amount / expense.splitBetween.length;
        return total + (expense.splitBetween.includes(userId) ? perPersonShare : 0);
    }, 0);
}

// Helper function to calculate total paid
function calculateTotalPaid(payments, userId) {
    return payments
        .filter(payment => payment.userId === userId)
        .reduce((total, payment) => total + payment.amount, 0);
}